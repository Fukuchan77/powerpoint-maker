Uninstalled 1 package in 1.17s
Installed 1 package in 189ms
Starting research on: Test Topic
Found 1 search results. Visiting pages...
Failed to parse LLM response: the JSON object must be str, bytes or bytearray, not list
Raw response: [MessageTextContent(type='text', text='\n                ```json\n                [\n                    {\n                        "layout_index": 0,\n                        "title": "Test Title",\n                        "content": ["Point 1", "Point 2"]\n                    }\n                ]\n                ```\n                ')]
F
=================================== FAILURES ===================================
______________________________ test_research_flow ______________________________

    @pytest.mark.asyncio
    async def test_research_flow():
        # Mock dependencies
        with patch('app.services.research.DuckDuckGoSearchTool') as MockSearch, \
             patch('app.services.research.get_llm') as mock_get_llm, \
             patch('app.services.research.DocumentConverter') as MockConverter:
    
            # Setup Mock Search
            mock_tool_instance = MockSearch.return_value
            # Mock results as a list of objects with url attribute
            mock_result_item = type('obj', (object,), {'url': 'http://example.com', 'description': 'desc'})
            mock_tool_instance.run = AsyncMock(return_value=type('obj', (object,), {
                'results': [mock_result_item]
            })())
    
            # Setup Mock LLM
            mock_llm_instance = mock_get_llm.return_value
            mock_llm_instance.generate = AsyncMock(return_value=type('obj', (object,), {
                'state': type('obj', (object,), {
                    'message': AssistantMessage(content='''
                    ```json
                    [
                        {
                            "layout_index": 0,
                            "title": "Test Title",
                            "content": ["Point 1", "Point 2"]
                        }
                    ]
                    ```
                    ''')
                })()
            })())
    
            # Setup Mock Converter
            mock_converter_instance = MockConverter.return_value
            mock_converter_instance.convert = AsyncMock() # Can be plain mock if run_in_executor mocks
    
            # Since we use run_in_executor, we might need to mock that or the converter call inside it
            # Easier: Mock _fetch_content method of the agent?
            # Or just trust the mock converter if we control it.
    
            agent = ResearchAgent()
    
            # Mock _fetch_content to avoid async loop issues with run_in_executor in test
            agent._fetch_content = AsyncMock(return_value="Mocked Page Content")
    
            slides = await agent.research("Test Topic")
    
>           assert len(slides) == 1
E           AssertionError: assert 3 == 1
E            +  where 3 = len([SlideContent(layout_index=0, title='Introduction to Test Topic', content=['Overview of Test Topic', 'Key importance',...ne), SlideContent(layout_index=1, title='Future Trends', content=['Trend 1', 'Trend 2', 'Conclusion'], image_url=None)])

tests/test_research_integration.py:55: AssertionError
================================ tests coverage ================================
_______________ coverage: platform darwin, python 3.13.7-final-0 _______________

Name                                 Stmts   Miss  Cover
--------------------------------------------------------
app/__init__.py                          0      0   100%
app/api/__init__.py                      0      0   100%
app/api/routes.py                       49     49     0%
app/core/llm.py                         13      9    31%
app/main.py                             12     12     0%
app/models/__init__.py                   0      0   100%
app/schemas.py                          30      0   100%
app/services/__init__.py                 0      0   100%
app/services/generator.py               49     49     0%
app/services/research.py                72     25    65%
app/services/template.py                21     21     0%
ddgs.py                                  1      0   100%
explore_bee.py                          10     10     0%
inspect_agent.py                         2      2     0%
inspect_bee.py                           6      6     0%
tests/test_research_integration.py      24      5    79%
--------------------------------------------------------
TOTAL                                  289    188    35%
=========================== short test summary info ============================
FAILED tests/test_research_integration.py::test_research_flow - AssertionErro...
1 failed in 7.55s
