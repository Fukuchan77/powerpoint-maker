[tools]
python = "3.12"
uv = "latest"
pnpm = "latest"
node = "lts"

[tasks]
# Backend Tasks
"backend:dev" = { run = "uv run fastapi dev app/main.py", dir = "backend", description = "Start backend dev server" }
"backend:lint" = { run = "uv run ruff check .", dir = "backend", description = "Lint backend code" }
"backend:format" = { run = "uv run ruff format .", dir = "backend", description = "Format backend code" }
"backend:test" = { run = "uv run python -m pytest", dir = "backend", description = "Run backend tests" }

# Frontend Tasks
"frontend:dev" = { run = "pnpm dev", dir = "frontend", description = "Start frontend dev server" }
"frontend:lint" = { run = "pnpm lint", dir = "frontend", description = "Lint frontend code" }
"frontend:format" = { run = "pnpm prettier --write .", dir = "frontend", description = "Format frontend code" }
"frontend:build" = { run = "pnpm build", dir = "frontend", description = "Build frontend" }
"frontend:test" = { run = "pnpm test", dir = "frontend", description = "Run frontend unit tests" }
"frontend:test:e2e" = { run = "pnpm test:e2e", dir = "frontend", description = "Run frontend E2E tests" }
"frontend:install" = { run = "pnpm install", dir = "frontend", description = "Install frontend dependencies" }

# Composite Tasks
"dev" = { depends = ["backend:dev", "frontend:dev"], description = "Start both servers" }
"install" = { depends = ["frontend:install"], description = "Install all dependencies" }

# CI/CD Tasks
"test-fast" = { run = """
#!/bin/bash
set -e
echo "ğŸ§ª Running fast backend tests..."
cd backend && uv run pytest tests/unit -v --tb=short -x
echo "ğŸ§ª Running frontend tests..."
cd ../frontend && pnpm test --run
echo "âœ… Fast tests passed!"
""", description = "Run fast unit tests only (for pre-push)" }

"test-full" = { run = """
#!/bin/bash
set -e
echo "ğŸ§ª Running all backend tests..."
cd backend && uv run pytest -v
echo "ğŸ§ª Running all frontend tests..."
cd ../frontend && pnpm test --run
echo "âœ… All tests passed!"
""", description = "Run all tests including integration and E2E" }

"build-check" = { run = """
#!/bin/bash
set -e
echo "ğŸ”¨ Checking frontend build..."
cd frontend && pnpm build
echo "âœ… Build check passed!"
""", description = "Verify builds work correctly" }

"pre-push-check" = { run = """
#!/bin/bash
set -e
echo "ğŸ” Running pre-push checks..."
echo "ğŸ“¦ Backend checks..."
cd backend
uv run ruff check .
uv run pytest tests/unit -v --tb=short -x
echo "ğŸ“¦ Frontend checks..."
cd ../frontend
pnpm exec tsc --noEmit
pnpm test --run
pnpm build
echo "âœ… All pre-push checks passed!"
""", description = "Run all pre-push checks (same as pre-push hook)" }

"setup-hooks" = { run = """
#!/bin/bash
set -e
echo "ğŸ”§ Setting up git hooks..."
cat > .git/hooks/pre-push << 'EOF'
#!/bin/bash
echo "ğŸš€ Running pre-push checks..."
echo ""
cd "$(git rev-parse --show-toplevel)"
echo "ğŸ“¦ Backend: Linting and fast tests..."
cd backend
if ! command -v uv &> /dev/null; then
  echo "âŒ Error: uv is not installed"
  exit 1
fi
if ! uv run ruff check .; then
  echo "âŒ Backend linting failed"
  exit 1
fi
echo "   âœ“ Linting passed"
if ! uv run pytest tests/unit -v --tb=short -x; then
  echo "âŒ Backend unit tests failed"
  exit 1
fi
echo "   âœ“ Unit tests passed"
cd ..
echo ""
echo "ğŸ“¦ Frontend: Type check, tests, and build..."
cd frontend
if ! command -v pnpm &> /dev/null; then
  echo "âŒ Error: pnpm is not installed"
  exit 1
fi
if ! pnpm exec tsc --noEmit; then
  echo "âŒ Frontend type check failed"
  exit 1
fi
echo "   âœ“ Type check passed"
if ! pnpm test --run; then
  echo "âŒ Frontend tests failed"
  exit 1
fi
echo "   âœ“ Tests passed"
if ! pnpm build; then
  echo "âŒ Frontend build failed"
  exit 1
fi
echo "   âœ“ Build passed"
cd ..
echo ""
echo "âœ… All pre-push checks passed! Pushing..."
EOF
chmod +x .git/hooks/pre-push
echo "âœ… Git hooks installed successfully!"
echo ""
echo "ğŸ’¡ To skip checks: git push --no-verify"
""", description = "Install git hooks for pre-push checks" }
